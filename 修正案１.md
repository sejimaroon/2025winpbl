# 修正計画案

## 1. 期限による枠線の色分けと並び替え
- [x] **期限表示のロジック変更**:
    - 期限3日前から前日までは黄色枠（`border-yellow-500`）
    - 期限当日以降は赤枠（`border-red-500`）
    - 解決済み（`current_status === 'SOLVED'`）の場合は枠線を消す
- [x] **トップページの並び順変更**:
    - 未解決（`UNREAD`, `CONFIRMED`, `WORKING`）を上に表示
    - 解決済み（`SOLVED`）を下に「解決済み」見出しの下に表示
    - 未解決の中での並び順は、期限が近い順 > 作成日が新しい順

## 2. TODOフィルターの改善（自分宛てのみ表示）
- [x] **TODOフィルターのロジック変更**:
    - ログインユーザーのID、職種、`@All` にメンションされている記事のみを表示
    - メンション判定には記事の本文（`content`）内の `@名前`、`@職種名`、`@All` を解析

## 3. ステータス表示（イニシャルアイコン）の変更
- [x] **表示形式の変更**:
    - 以下のセクション分けで表示
        - **担当**: `WORKING` ステータスのユーザー
        - **未確認**: メンションされているが、まだアクションを起こしていないユーザー
        - **確認済**: `CONFIRMED` ステータスのユーザー
    - アイコンの色は職種により色分け（医師:青、看護師:ピンク、事務:黄色）

## 4. 解決済み時の表示変更
- [x] **解決者表示**:
    - 解決済みの場合、解決者のフルネームとタイムスタンプを表示
    - `DIARY` テーブルに `solved_by` (INT → STAFF) と `solved_at` (TIMESTAMP) カラムを追加

## 5. リプライの改善
- [x] **アイコンの職種別色分け**:
    - 医師: 青
    - 看護師: ピンク
    - 事務: 黄色
- [x] **リプライの至急フラグ**:
    - リプライ投稿時に `is_urgent` を設定可能にする
    - `is_urgent` がONのリプライは赤枠で囲む
    - 親記事が解決済み（`current_status === 'SOLVED'`）なら赤枠解除
- [x] **リプライの編集・削除**:
    - 投稿者と管理者が編集・削除可能にする

## 6. アクションボタンの改善（トグル機能）
- [x] **ボタンのトグル動作**:
    - 既にその状態なら、ボタン押下で解除（`UNREAD`に戻す）
    - 背景色でON/OFFを表現
        - 確認: 薄緑
        - 作業中: 薄青
        - 解決: 薄紫
- [x] **ボタン名の変更**:
    - 「確認」→「確認した」
    - 「返信」→「返信する」
    - 「解決」→「解決済み」
- [x] **ポイントロジックの変更**:
    - ONでポイント付与、OFFでポイント取り消し
    - 各アクション（確認、作業中、解決）につき1回のみポイント付与（重複防止）
    - ポイント: 確認=1pt, 作業中=5pt, 解決=10pt

## 実装ステップ

### ステップ1: データベース変更 ✅
- `DIARY` テーブルに `solved_by`, `solved_at`, `deadline` カラム追加

### ステップ2: 型定義の更新 ✅
- `Diary` 型に新カラム追加
- `DiaryWithRelations` に解決者情報追加

### ステップ3: Server Actions (`diary.ts`) の修正 ✅
- `getDiariesByDate`: 並び順変更、メンション解析ロジック（TODOフィルタ用）、`solved_by_staff`取得
- `updateUserDiaryStatus`: トグル動作、ポイント加算/減算ロジック、解決時の解決者記録

### ステップ4: コンポーネントの修正 ✅
- `DiaryCard.tsx`: 
  - 枠線ロジック（至急/期限/解決済み）
  - ステータス表示（担当/未確認/確認済のセクション分け）
  - 解決者表示
  - アクティブなボタンのスタイル
  - ボタン名変更（確認した/返信する/解決済み）
- `DiaryList.tsx` / `DiaryListClient.tsx`: 未解決・解決済みの分離表示、allStaff/jobTypes渡し
- アイコン: 職種による色分け対応

### ステップ5: リプライ機能の強化 ✅
- リプライの至急フラグ表示、編集・削除ボタン
- 投稿フォームでの至急フラグ追加

---

## 進捗状況

| ステップ | 項目 | 状態 |
|---------|------|------|
| 1 | データベース変更 | ✅ 完了 |
| 2 | 型定義の更新 | ✅ 完了 |
| 3 | Server Actions修正 | ✅ 完了 |
| 4 | コンポーネント修正 | ✅ 完了 |
| 5 | リプライ機能強化 | ✅ 完了 |

---

## 実行済みSQL

```sql
-- 期限カラムの追加
ALTER TABLE "DIARY" ADD COLUMN IF NOT EXISTS deadline DATE;

-- 解決者カラムの追加
ALTER TABLE "DIARY" ADD COLUMN IF NOT EXISTS solved_by INT REFERENCES "STAFF"(staff_id);

-- 解決日時カラムの追加
ALTER TABLE "DIARY" ADD COLUMN IF NOT EXISTS solved_at TIMESTAMP WITH TIME ZONE;

-- 編集者カラムの追加
ALTER TABLE "DIARY" ADD COLUMN IF NOT EXISTS updated_by INT REFERENCES "STAFF"(staff_id);
```
